/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 56913dc1-5fee-4513-ac85-f55ab67289d5
-/

/-
This module defines the necessary structures for the A3 Cap Combine Lemma, including an abstract Hilbert space `HS` (modeled as `lp (fun _ : ℕ => ℝ) 2`), the Toeplitz operator `ToeplitzOp`, and various properties like `IsPSD`, `TraceCap`, and `norm_infty`. It then proves the main lemmas `cap_combine` and `a3_lock_from_cap`, which establish the positivity and norm bounds for the Toeplitz operator under the trace-cap hypothesis and symbol floor condition. The proofs rely on standard properties of Toeplitz operators which are provided as hypotheses to the lemmas.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

opaque H : Type

#check lp

noncomputable def HS := lp (fun _ : ℕ => ℝ) 2

#check (2 : ENNReal)

#synth Fact ((1 : ENNReal) ≤ 2)

#synth NormedAddCommGroup (lp (fun _ : ℕ => ℝ) 2)

noncomputable instance : NormedAddCommGroup HS := lp.normedAddCommGroup

#check lp.instInnerProductSpace

noncomputable instance : InnerProductSpace ℝ HS := lp.instInnerProductSpace

noncomputable opaque ToeplitzOp (P_A : ℝ → ℝ) : HS →L[ℝ] HS

noncomputable def op_norm (T : HS →L[ℝ] HS) : ℝ := ‖T‖

def IsLip (P_A : ℝ → ℝ) : Prop := LipschitzWith 1 P_A

noncomputable def norm_infty (f : ℝ → ℝ) : ℝ := sSup (Set.range (fun x => |f x|))

def HasPosFloor (P_A : ℝ → ℝ) (c₀ : ℝ) : Prop := ∀ θ, P_A θ ≥ c₀

def IsPSD (T : HS →L[ℝ] HS) (c : ℝ) : Prop :=
  ∀ f : HS, inner ℝ (T f) f ≥ c * inner ℝ f f

def TraceCap (T : HS →L[ℝ] HS) (ρ : ℝ) : Prop := op_norm T ≤ ρ

/-
If a symbol P_A has a positive floor c₀ and its Toeplitz operator satisfies a trace-cap bound ρ, then (assuming standard Toeplitz properties) the operator is PSD with constant c₀ and its norm is bounded by max(ρ, ‖P_A‖_∞).
-/
lemma cap_combine (P_A : ℝ → ℝ) (c₀ ρ : ℝ)
    (hLip : IsLip P_A)
    (hFloor : HasPosFloor P_A c₀)
    (hc₀ : c₀ > 0)
    (hTraceCap : TraceCap (ToeplitzOp P_A) ρ)
    (hToeplitzPos : ∀ c, HasPosFloor P_A c → IsPSD (ToeplitzOp P_A) c)
    (hToeplitzNorm : op_norm (ToeplitzOp P_A) ≤ norm_infty P_A) :
    IsPSD (ToeplitzOp P_A) c₀ ∧ op_norm (ToeplitzOp P_A) ≤ max ρ (norm_infty P_A) := by
  exact ⟨ hToeplitzPos c₀ hFloor, le_max_of_le_right hToeplitzNorm ⟩

/-
When the trace-cap bound ρ is at most c₀/4, the Toeplitz operator is PSD with constant c₀ and its norm is bounded by c₀/4 + ‖P_A‖_∞.
-/
lemma a3_lock_from_cap (P_A : ℝ → ℝ) (c₀ ρ : ℝ)
    (hLip : IsLip P_A)
    (hFloor : HasPosFloor P_A c₀)
    (hc₀ : c₀ > 0)
    (hρ : ρ ≤ c₀ / 4)
    (hTraceCap : TraceCap (ToeplitzOp P_A) ρ)
    (hToeplitzPos : ∀ c, HasPosFloor P_A c → IsPSD (ToeplitzOp P_A) c)
    (hToeplitzNorm : op_norm (ToeplitzOp P_A) ≤ norm_infty P_A) :
    IsPSD (ToeplitzOp P_A) c₀ ∧
    op_norm (ToeplitzOp P_A) ≤ c₀ / 4 + norm_infty P_A := by
  exact ⟨ hToeplitzPos c₀ hFloor, le_trans hToeplitzNorm ( by linarith ) ⟩