/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: f758546b-4b31-4436-8c0d-9759b15d043b
-/

/-
Formalization of the Riemann Hypothesis proof dossier.
Defines the Riemann Zeta function, Critical Strip, Weil Cone, and the Q functional.
Encapsulates the provided axioms (A1, A2, A3, T5, etc.) in the `RHAxioms` typeclass.
Proves `Main_positivity` (Q(Phi) >= 0 for all Phi in Weil Cone) using the axioms.
Proves `RH` (Riemann Hypothesis) as a consequence of `Main_positivity` and Weil's criterion.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#check (Complex.I : ℂ)
#check (star : ℂ → ℂ)
example (z : ℂ) : star z = z.re - Complex.I * z.im := by
  -- By definition of conjugate for complex numbers, we have star z = z.re - Complex.I * z.im.
  simp [Complex.ext_iff]

open Real Complex MeasureTheory Set
open scoped BigOperators

def Riemann_Hypothesis : Prop :=
  forall s : ℂ, riemannZeta s = 0 -> 0 < s.re -> s.re < 1 -> s.re = 1/2

-- Critical strip
def CriticalStrip : Set ℂ := {s | 0 < s.re ∧ s.re < 1}

-- Critical line
def CriticalLine : Set ℂ := {s | s.re = 1/2}

-- Weil cone: test functions for positivity criterion
def Weil_cone : Set (ℝ -> ℂ) :=
  {Phi | Continuous Phi ∧
         HasCompactSupport Phi ∧
         (forall x, Phi (-x) = star (Phi x))}

opaque Q : (ℝ → ℂ) → ℝ

-- Digamma function
noncomputable def digamma (z : ℂ) : ℂ := (deriv Complex.Gamma z) / (Complex.Gamma z)

-- Archimedean density
noncomputable def a (xi : ℝ) : ℝ := Real.log Real.pi - (digamma (1/4 + Complex.I * Real.pi * xi)).re

-- Fejer x heat window
noncomputable def w (B t xi : ℝ) : ℝ :=
  max 0 (1 - |xi| / B) * Real.exp (-4 * Real.pi^2 * t * xi^2)

-- Weighted density
noncomputable def g (B t xi : ℝ) : ℝ := a xi * w B t xi

-- Archimedean symbol (periodized)
noncomputable def P_A (B t theta : ℝ) : ℝ :=
  2 * Real.pi * tsum (fun m : ℤ => g B t (theta + m))

-- Key Constants
noncomputable def B_min : ℝ := 3
noncomputable def t_sym : ℝ := 3 / 50
noncomputable def c_star : ℝ := 1.5
noncomputable def C_SB : ℝ := 4

-- Definition of W_K
def W_K (K : ℝ) : Set (ℝ → ℂ) :=
  {Phi | Phi ∈ Weil_cone ∧ Function.support Phi ⊆ Icc (-K) K}

-- 2. Approximants and Density
opaque IsApproximant : (ℝ → ℂ) → Prop

-- 1. Compact Support Lemma
lemma Weil_cone_compact_support (Phi : ℝ → ℂ) (h : Phi ∈ Weil_cone) :
    exists K, K > 0 ∧ Function.support Phi ⊆ Icc (-K) K := by
      -- Since $\Phi$ is continuous and has compact support, its support is bounded.
      have h_support_bounded : Bornology.IsBounded (Function.support Phi) := by
        -- Since $\Phi$ has compact support, its support is bounded.
        have h_support_compact : HasCompactSupport Phi := by
          exact h.2.1;
        exact h_support_compact.isCompact.isBounded.subset ( subset_closure );
      rcases h_support_bounded.exists_pos_norm_le with ⟨ K, hK ⟩ ; exact ⟨ K, hK.1, fun x hx => ⟨ by linarith [ abs_le.mp ( hK.2 x hx ) ], by linarith [ abs_le.mp ( hK.2 x hx ) ] ⟩ ⟩

class RHAxioms where
  -- 2. Approximants and Density
  A1_density : forall (K : ℝ) (Phi : ℝ → ℂ), Phi ∈ W_K K →
    exists seq : ℕ → (ℝ → ℂ), (forall n, IsApproximant (seq n)) ∧ Filter.Tendsto (fun n => Q (seq n)) Filter.atTop (nhds (Q Phi))

  -- 3. Positivity on Approximants (T5)
  T5_transfer : forall f, IsApproximant f → Q f >= c_star / 4

  -- 4. Weil's Criterion
  Weil_criterion : (forall Phi, Phi ∈ Weil_cone → Q Phi >= 0) ↔ Riemann_Hypothesis

theorem Main_positivity [RHAxioms] : forall Phi, Phi ∈ Weil_cone → Q Phi >= 0 := by
  rename_i h;
  -- By the approximation property, we can find a sequence of approximants converging to Phi.
  intros Phi hPhi
  obtain ⟨seq, hseq_approx, hseq_conv⟩ := h.A1_density (Weil_cone_compact_support Phi hPhi).choose Phi (by
  -- By definition of $W_K$, we need to show that $\Phi \in Weil_cone$ and $\text{support}(\Phi) \subseteq [-K, K]$.
  apply And.intro hPhi;
  -- By definition of $K$, we know that the support of $\Phi$ is contained within $[-K, K]$.
  apply (Weil_cone_compact_support Phi hPhi).choose_spec.right);
  -- By the properties of $Q$, we know that $Q(seq n) \geq c_star / 4$ for all $n$.
  have h_Q_seq : ∀ n, Q (seq n) ≥ c_star / 4 := by
    exact fun n => h.T5_transfer _ ( hseq_approx n );
  exact le_of_tendsto_of_tendsto' tendsto_const_nhds hseq_conv fun n => le_trans ( by norm_num [ show c_star = 1.5 by rfl ] ) ( h_Q_seq n )

theorem RH [RHAxioms] : Riemann_Hypothesis := by
  cases' ‹RHAxioms› with h1 h2 h3 h4;
  refine' h3.mp _;
  intro Phi hPhi
  obtain ⟨K, hK⟩ : ∃ K : ℝ, K > 0 ∧ Function.support Phi ⊆ Set.Icc (-K) K := by
    exact?;
  obtain ⟨ seq, hseq₁, hseq₂ ⟩ := h1 K Phi ⟨ hPhi, hK.2 ⟩;
  exact le_of_tendsto_of_tendsto' tendsto_const_nhds hseq₂ fun n => le_trans ( by linarith [ show 0 ≤ c_star by norm_num [ c_star ] ] ) ( h2 _ ( hseq₁ n ) )