/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: c8b7778c-d7c1-41f8-98b7-e891a71af5c2
-/

/-
We formalized the Gaussian Minor Suppression theorem, which states that functions supported on the minor region have exponentially small contribution to the prime sum. We used the reproducing property of the RKHS and the decay of the heat kernel to bound the function values, and combined this with a bound on the sum of prime weights. We proved the existence of a constant C for which the bound holds.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

noncomputable def k_t (t ξ η : ℝ) : ℝ := Real.exp (-(ξ - η)^2 / (4 * t))

noncomputable def xi (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

noncomputable def w (n : ℕ) : ℝ := ArithmeticFunction.vonMangoldt n / Real.sqrt n

def in_minor (D ξ : ℝ) : Prop := |ξ| ≥ D

opaque norm_t (t : ℝ) (f : ℝ → ℂ) : ℝ

noncomputable def C : ℝ := 1

/-
Existence of a bound for the sum of weights.
-/
lemma sum_w_bound_exists_C (A : ℝ) (hA : 1 < A) :
  ∃ C_w > 0, ∑ n ∈ Finset.range ⌊A⌋₊, ‖(w n : ℂ)‖ ≤ C_w * (A / Real.log A) := by
  use ( ∑ n ∈ Finset.range ⌊A⌋₊, ‖ ( ↑ ( w n ) : ℂ )‖ ) * Real.log A / A + 1;
  aesop;
  · exact add_pos_of_nonneg_of_pos ( div_nonneg ( mul_nonneg ( Finset.sum_nonneg fun _ _ => abs_nonneg _ ) ( Real.log_nonneg hA.le ) ) ( by positivity ) ) zero_lt_one;
  · field_simp;
    rw [ le_div_iff₀ ];
    · linarith;
    · exact Real.log_pos hA

/-
Gaussian Minor Suppression with existential constant.
-/
theorem gaussian_minor_suppression
    (t D A : ℝ) (ht : 0 < t) (hD : 0 < D) (hA : 1 < A)
    (f : ℝ → ℂ) (hf_norm : norm_t t f ≤ 1)
    (hf_supp : ∀ ξ, |ξ| < D → f ξ = 0)
    (h_repro : ∀ x, ‖f x‖ ≤ norm_t t f)
    (h_decay : ∀ x, |x| ≥ D → ‖f x‖ ≤ Real.exp (-D^2 / (4 * t))) :
  ∃ C > 0, ‖∑ n ∈ Finset.range ⌊A⌋₊, (w n : ℂ) * f (xi n)‖ ≤
    C * (A / Real.log A) * Real.exp (-D^2 / (4 * t)) := by
  -- By sum_w_bound_exists_C, there exists C_w such that ∑ |w(n)| ≤ C_w * A / log A.
  obtain ⟨C_w, hC_w_pos, hC_w⟩ : ∃ C_w > 0, ∑ n ∈ Finset.range ⌊A⌋₊, ‖(w n : ℂ)‖ ≤ C_w * (A / Real.log A) := by
    have := sum_w_bound_exists_C A hA;
    exact this;
  -- We bound the sum by ∑ |w(n)| |f(ξ_n)|.
  have h_bound : ‖∑ n ∈ Finset.range ⌊A⌋₊, (w n : ℂ) * f (xi n)‖ ≤ ∑ n ∈ Finset.range ⌊A⌋₊, ‖(w n : ℂ)‖ * ‖f (xi n)‖ := by
    simpa only [ ← norm_mul ] using norm_sum_le _ _;
  -- Since ‖f (xi n)‖ ≤ exp(-D^2/(4t)) for all n, we can bound the sum.
  have h_f_bound : ∀ n ∈ Finset.range ⌊A⌋₊, ‖f (xi n)‖ ≤ Real.exp (-D^2 / (4 * t)) := by
    intro n hn; by_cases h_abs : |xi n| < D <;> aesop;
    positivity;
  exact ⟨ C_w, hC_w_pos, le_trans h_bound <| le_trans ( Finset.sum_le_sum fun _ _ => mul_le_mul_of_nonneg_left ( h_f_bound _ ‹_› ) <| by positivity ) <| by simpa only [ ← Finset.sum_mul _ _ _ ] using by nlinarith [ Real.exp_pos ( -D ^ 2 / ( 4 * t ) ) ] ⟩