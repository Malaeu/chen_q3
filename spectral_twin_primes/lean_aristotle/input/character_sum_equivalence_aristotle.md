/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: a9aec2a9-8d0b-4a4a-9be7-cc0fc9fdd304

Sorry, Aristotle was unable to complete the task in time.

-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Character sum S(t) defined as sum of exponentials of spectral coordinates.
-/
def S {N : â„•} (t : â„) (Î¾ : Fin N â†’ â„) : â„‚ := âˆ‘ k, Complex.exp (-2 * Real.pi * Complex.I * t * Î¾ k)

/-
Definitions of mean, variance, standard deviation, and coefficient of variation for a function on Fin n.
-/
def mean {n : â„•} (f : Fin n â†’ â„) : â„ := (âˆ‘ i, f i) / n

def variance {n : â„•} (f : Fin n â†’ â„) : â„ := (âˆ‘ i, (f i - mean f)^2) / n

def stdDev {n : â„•} (f : Fin n â†’ â„) : â„ := Real.sqrt (variance f)

def cv {n : â„•} (f : Fin n â†’ â„) : â„ := (stdDev f) / (mean f)

/-
Definition of gaps between consecutive elements and the Twin Prime Conjecture.
-/
def gaps {N : â„•} (Î¾ : Fin N â†’ â„) : Fin (N - 1) â†’ â„ :=
  fun i =>
    let j1 : Fin N := i.succ.cast (by
    -- Since $N$ is a positive integer, we can simplify $N - 1 + 1$ to $N$.
    cases N <;> simp_all +decide;
    -- Since Fin 0 has no elements, this leads to a contradiction.
    exact Fin.elim0 i)
    let j2 : Fin N := i.castSucc.cast (by
    all_goals generalize_proofs at *;
    linarith)
    Î¾ j1 - Î¾ j2

def TPC : Prop := âˆ€ N, âˆƒ p â‰¥ N, Nat.Prime p âˆ§ Nat.Prime (p + 2)

/-
Checking existence of Nat.nth and Set.Infinite
-/
#check Nat.nth
#check Set.Infinite

/-
Checking for Complex.normSq
-/
#check Complex.normSq

/-
Fourier-Variance Bridge: |S(t)|Â² relates to the sum of cosines of the gaps.
-/
theorem lemma1_fourier_variance_bridge {N : â„•} (t : â„) (Î¾ : Fin N â†’ â„) :
  Complex.normSq (S t Î¾) = N + 2 * âˆ‘ i : Fin N, âˆ‘ j âˆˆ Finset.filter (Â· > i) Finset.univ, Real.cos (2 * Real.pi * t * (Î¾ j - Î¾ i)) := by
    unfold S;
    induction' N with N ih;
    Â· norm_num;
    Â· rw [ Fin.sum_univ_succ, Complex.normSq_add ] ; aesop;
      simp +decide [ Fin.sum_univ_succ, Complex.normSq, Complex.exp_re, Complex.exp_im ];
      simp +decide [ Fin.sum_univ_succ, Finset.sum_add_distrib, Finset.mul_sum _ _ _, mul_assoc, mul_left_comm, mul_sub, Real.cos_sub, Real.sin_sub ];
      simp +decide [ Fin.sum_univ_succ, Finset.sum_filter, Finset.sum_add_distrib, mul_comm, mul_left_comm, mul_assoc ] ; ring;
      norm_num [ Real.cos_sq' ]

/-
Small-t expansion of the character sum squared modulus.
-/
open Asymptotics Filter Topology

theorem lemma2_small_t_expansion {N : â„•} (Î¾ : Fin N â†’ â„) :
  (fun t => Complex.normSq (S t Î¾) - (N^2 - (2 * Real.pi * t)^2 * (N^2 * variance Î¾))) =O[nhds 0] (fun t => t^4) := by
    -- We'll use the fact that $|S(t)|^2$ is equal to $N^2$ minus some small terms of order $t^4$. Hence, we need to show that the remaining terms are $O(t^4)$.
    have h1 : (fun t : â„ => Complex.normSq (S t Î¾) - (N^2 - (2 * Real.pi * t)^2 * (N^2 * variance Î¾))) =O[ğ“ 0] (fun t : â„ => t^4) := by
      have h_taylor : âˆ€ t : â„, Complex.normSq (S t Î¾) = N^2 - (2 * Real.pi * t)^2 * (N^2 * variance Î¾) + (fun t : â„ => âˆ‘ i : Fin N, âˆ‘ j âˆˆ Finset.filter (Â· > i) Finset.univ, (Real.cos (2 * Real.pi * t * (Î¾ j - Î¾ i)) - 1 + (2 * Real.pi * t * (Î¾ j - Î¾ i))^2 / 2)) t * 2 := by
        intro t
        rw [lemma1_fourier_variance_bridge];
        norm_num [ Finset.sum_add_distrib, Finset.mul_sum _ _ _, Finset.sum_mul _ _ _, mul_pow ];
        -- We'll use the fact that $\sum_{x < y} (\xi_y - \xi_x)^2 = N \sum_{x} (\xi_x - \text{mean}(\xi))^2$.
        have h_sum_sq_diff : âˆ‘ x : Fin N, âˆ‘ x_1 : Fin N with x < x_1, (Î¾ x_1 - Î¾ x) ^ 2 = N * âˆ‘ x : Fin N, (Î¾ x - mean Î¾) ^ 2 := by
          -- By expanding the squares and rearranging the sums, we can show that both sides are equal.
          have h_expand : âˆ‘ x : Fin N, âˆ‘ x_1 : Fin N with x < x_1, (Î¾ x_1 - Î¾ x) ^ 2 = N * (âˆ‘ x : Fin N, Î¾ x ^ 2) - (âˆ‘ x : Fin N, Î¾ x) ^ 2 := by
            induction' N with N ih <;> simp_all +decide [ Fin.sum_univ_succ, Finset.sum_filter ] ; ring;
            simpa [ Finset.sum_add_distrib, Finset.mul_sum _ _ _, Finset.sum_mul _ _ _ ] using by ring;
          simp_all +decide [ sub_sq, Finset.sum_add_distrib, Finset.mul_sum _ _ _, Finset.sum_mul _ _ _ ];
          unfold mean; norm_num [ â† Finset.mul_sum _ _ _, â† Finset.sum_mul ] ; ring;
          by_cases hN : N = 0 <;> simp +decide [ hN, sq, mul_assoc, mul_comm, mul_left_comm ];
          Â· aesop;
          Â· ring;
        norm_num [ â† Finset.mul_sum _ _ _, â† Finset.sum_div, h_sum_sq_diff ] ; ring;
        unfold variance; ring;
        by_cases hN : N = 0 <;> simp_all +decide [ sq, mul_assoc, mul_comm, mul_left_comm ];
        Â· aesop;
        Â· rw [ show ( âˆ‘ x : Fin N, ( Finset.card ( Finset.filter ( fun x_1 => x < x_1 ) Finset.univ ) : â„ ) ) = N * ( N - 1 ) / 2 from ?_ ] ; ring;
          norm_num [ Finset.filter_lt_eq_Ioi ];
          exact Nat.recOn N ( by norm_num ) fun n ih => by cases n <;> norm_num [ Nat.mul_succ, Fin.sum_univ_castSucc ] at * ; linarith;
      -- We'll use the fact that $|\cos(x) - 1 + x^2 / 2|$ is bounded by a constant times $x^4$.
      have h_cos_bound : âˆ€ x : â„, abs (Real.cos x - 1 + x^2 / 2) â‰¤ x^4 / 24 := by
        -- We'll use the fact that $|\cos(x) - 1 + x^2 / 2| \leq x^4 / 24$ for all $x$.
        intros x
        have h_cos_bound : âˆ€ x : â„, abs (Real.cos x - 1 + x^2 / 2) â‰¤ x^4 / 24 := by
          intro x
          have h_cos_bound_aux : âˆ€ x : â„, 0 â‰¤ x â†’ abs (Real.cos x - 1 + x^2 / 2) â‰¤ x^4 / 24 := by
            -- We'll use the fact that $|\cos(x) - 1 + x^2 / 2| \leq x^4 / 24$ for all $x \geq 0$.
            intros x hx
            have h_cos_bound_aux : âˆ€ x : â„, 0 â‰¤ x â†’ Real.cos x - 1 + x^2 / 2 â‰¤ x^4 / 24 := by
              -- We'll use the fact that the derivative of $\cos(x)$ is $-\sin(x)$ and the derivative of $1 - x^2 / 2 + x^4 / 24$ is $-x + x^3 / 6$.
              have h_deriv_bound : âˆ€ x : â„, 0 â‰¤ x â†’ -Real.sin x â‰¤ -x + x^3 / 6 := by
                -- We'll use the fact that the derivative of $\sin(x)$ is $\cos(x)$ and the derivative of $x - x^3 / 6$ is $1 - x^2 / 2$.
                have h_deriv_bound : âˆ€ x : â„, 0 â‰¤ x â†’ Real.cos x â‰¥ 1 - x^2 / 2 := by
                  exact?;
                -- Integrate both sides of $\cos(x) \geq 1 - x^2 / 2$ from $0$ to $x$.
                have h_integral_bound : âˆ€ x : â„, 0 â‰¤ x â†’ âˆ« t in (0 : â„)..x, Real.cos t â‰¥ âˆ« t in (0 : â„)..x, (1 - t^2 / 2) := by
                  intro x hx; refine' intervalIntegral.integral_mono_on _ _ _ _ <;> aesop;
                intro x hx; have := h_integral_bound x hx; norm_num at this; linarith;
              -- Integrate both sides of $-\sin(x) \leq -x + x^3 / 6$ from $0$ to $x$.
              have h_integral_bound : âˆ€ x : â„, 0 â‰¤ x â†’ âˆ« t in (0 : â„)..x, -Real.sin t â‰¤ âˆ« t in (0 : â„)..x, -t + t^3 / 6 := by
                intro x hx; refine' intervalIntegral.integral_mono_on _ _ _ _ <;> aesop;
                Â· exact Continuous.intervalIntegrable ( by continuity ) _ _;
                Â· exact Continuous.intervalIntegrable ( by continuity ) _ _;
              intro x hx; have := h_integral_bound x hx; norm_num [ neg_add_eq_sub ] at this; linarith;
            rw [ abs_of_nonneg ];
            Â· exact h_cos_bound_aux x hx;
            Â· -- We'll use the fact that $|\cos(x) - 1 + x^2 / 2| \leq x^4 / 24$ for all $x \geq 0$. This follows from the Taylor series expansion of $\cos(x)$.
              have h_cos_bound_aux : âˆ€ x : â„, 0 â‰¤ x â†’ Real.cos x â‰¥ 1 - x^2 / 2 := by
                exact?;
              linarith [ h_cos_bound_aux x hx ]
          cases abs_cases x <;> simp +decide [ * ];
          convert h_cos_bound_aux ( -x ) ( by linarith ) using 1 <;> norm_num;
        exact h_cos_bound x;
      -- Applying the bound on $|\cos(x) - 1 + x^2 / 2|$ to each term in the sum, we get that the sum is bounded by a constant times $t^4$.
      have h_sum_bound : âˆ€ t : â„, abs (âˆ‘ i : Fin N, âˆ‘ j âˆˆ Finset.filter (Â· > i) Finset.univ, (Real.cos (2 * Real.pi * t * (Î¾ j - Î¾ i)) - 1 + (2 * Real.pi * t * (Î¾ j - Î¾ i))^2 / 2)) â‰¤ (âˆ‘ i : Fin N, âˆ‘ j âˆˆ Finset.filter (Â· > i) Finset.univ, (2 * Real.pi * (Î¾ j - Î¾ i))^4 / 24) * t^4 := by
        intros t
        have h_term_bound : âˆ€ i j : Fin N, j > i â†’ abs (Real.cos (2 * Real.pi * t * (Î¾ j - Î¾ i)) - 1 + (2 * Real.pi * t * (Î¾ j - Î¾ i))^2 / 2) â‰¤ (2 * Real.pi * (Î¾ j - Î¾ i))^4 / 24 * t^4 := by
          exact fun i j hij => le_trans ( h_cos_bound _ ) ( by ring_nf; norm_num );
        exact le_trans ( Finset.abs_sum_le_sum_abs _ _ ) ( by simpa only [ Finset.sum_mul _ _ _ ] using Finset.sum_le_sum fun i hi => Finset.abs_sum_le_sum_abs _ _ |> le_trans <| Finset.sum_le_sum fun j hj => h_term_bound i j <| Finset.mem_filter.mp hj |>.2 );
      rw [ Asymptotics.isBigO_iff ];
      exact âŸ¨ ( âˆ‘ i : Fin N, âˆ‘ j : Fin N with j > i, ( 2 * Real.pi * ( Î¾ j - Î¾ i ) ) ^ 4 / 24 ) * 2, Filter.Eventually.of_forall fun x => by cases abs_cases x <;> simpa [ * ] using by nlinarith [ h_sum_bound x ] âŸ©;
    exact h1

/-
Helper lemma: Sum of squares identity.
-/
theorem sum_sq_eq_n_mul_var_add_mean_sq {n : â„•} (f : Fin n â†’ â„) :
  âˆ‘ i, (f i)^2 = n * (variance f + (mean f)^2) := by
    unfold variance mean;
    by_cases hn : n = 0 <;> simp_all +decide [ Finset.sum_add_distrib, sub_sq, Finset.mul_sum _ _ _, mul_div_cancelâ‚€ ];
    Â· aesop;
    Â· -- Combine like terms and simplify the resulting expression.
      field_simp
      ring;
      simp [ â† Finset.mul_sum _ _ _, â† Finset.sum_mul, hn, sq, mul_assoc, mul_comm, mul_left_comm ]

/-
Connection between sum of squared gaps and coefficient of variation.
-/
theorem lemma3_variance_cv_connection {N : â„•} (Î¾ : Fin N â†’ â„) (h_mean : mean (gaps Î¾) â‰  0) :
  let g := gaps Î¾
  âˆ‘ i, (g i)^2 = (N - 1) * (mean g)^2 * (1 + (cv g)^2) := by
    -- Apply the lemma sum_sq_eq_n_mul_var_add_mean_sq:
    have h_var : âˆ‘ i : Fin (N - 1), (gaps Î¾ i) ^ 2 = (N - 1) * (variance (gaps Î¾) + (mean (gaps Î¾)) ^ 2) := by
      cases N <;> norm_num at *;
      Â· unfold mean variance gaps at * ; aesop;
      Â· convert sum_sq_eq_n_mul_var_add_mean_sq ( gaps Î¾ ) using 1;
    -- Substitute the definition of variance:
    have h_var_def : variance (gaps Î¾) = (cv (gaps Î¾)) ^ 2 * (mean (gaps Î¾)) ^ 2 := by
      unfold cv; ring_nf; aesop;
      rw [ show variance ( gaps Î¾ ) = ( Real.sqrt ( variance ( gaps Î¾ ) ) ) ^ 2 by rw [ Real.sq_sqrt ( show 0 â‰¤ variance ( gaps Î¾ ) from div_nonneg ( Finset.sum_nonneg fun _ _ => sq_nonneg _ ) ( Nat.cast_nonneg _ ) ) ], show stdDev ( gaps Î¾ ) = Real.sqrt ( variance ( gaps Î¾ ) ) by rfl ];
    exact h_var.trans ( by rw [ h_var_def ] ; ring )