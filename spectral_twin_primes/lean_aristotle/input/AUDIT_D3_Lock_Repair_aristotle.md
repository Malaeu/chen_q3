/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 7975d2a3-998e-4da5-973d-59e2ea1342a8
-/

/-
Formalization of the D3-Lock Repair from Formal Audit Document 25.
This module defines the model expectation `E_model` using the Archimedean density `rho_A`
and proves the `D3_lock_repaired` theorem which bounds the error between the prime functional `L_A`
and the model expectation, assuming the Q3 spectral gap property.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Definition of model expectation as the integral of f against the density rho_A over [-K, K].
-/
open MeasureTheory Set Filter intervalIntegral

noncomputable def E_model (A K : ℝ) (f : ℝ → ℂ) (rho_A : ℝ → ℝ) : ℂ :=
  ∫ x in Icc (-K) K, f x * rho_A x

/-
A helper inequality lemma: if a ≤ b * c, c ≤ 1, b ≤ d, and b ≥ 0, then a ≤ d.
-/
lemma bound_helper (a b c d : ℝ) (h_nonneg_b : 0 ≤ b) (h1 : a ≤ b * c) (h2 : c ≤ 1) (h3 : b ≤ d) : a ≤ d := by
  nlinarith

/-
The D3-Lock Repaired theorem states that the prime functional L_A is approximated by the model expectation E_model scaled by the total prime weight v_norm_sq, with an error bound C_K * delta_A. This is proven using the spectral gap property and a helper inequality.
-/
open MeasureTheory Set Filter intervalIntegral Real Complex

/-- D3-Lock Repaired: prime functional approximated by model -/
theorem D3_lock_repaired {H : Type*} [NormedAddCommGroup H] [InnerProductSpace ℂ H] [CompleteSpace H] [CoeFun H (fun _ => ℝ → ℂ)]
    (A K : ℝ) (f : H) (hf : ‖f‖ ≤ 1)
    (rho_A : ℝ → ℝ) (delta_A : ℝ) (hdelta : delta_A > 0)
    (L_A : H → ℂ) (v_norm_sq : ℂ) (C_K : ℝ)
    (v_norm : ℝ) (hv_sq : v_norm_sq = v_norm ^ 2) (h_v_nonneg : 0 ≤ v_norm)
    (gap : ℝ) (h_gap_nonneg : 0 ≤ gap)
    (h_spectral : ∀ g : H, ‖L_A g - E_model A K g rho_A * v_norm_sq‖ ≤ gap * ‖g‖ * v_norm)
    (h_gap_bound : gap * v_norm ≤ C_K * delta_A) :
  ‖L_A f - E_model A K f rho_A * v_norm_sq‖ ≤ C_K * delta_A := by
  refine' le_trans ( h_spectral f ) ( by nlinarith [ mul_nonneg h_v_nonneg h_gap_nonneg ] )