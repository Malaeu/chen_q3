/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: f92a8dfa-34e2-47bb-8d65-d22d3cf6b51b
-/

/-
Formalization of the bridge between GEH-2 (number theory) and E_comm (operator theory).
Includes definitions for E2 error term, GEH-2 condition, Modular Hamiltonian, Accumulated Hamiltonian,
E_comm restricted to residue classes, and Variance in class.
Formalizes the statements of Theorems 1-5 relating these quantities.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

#check ArithmeticFunction.vonMangoldt
#check Nat.totient

/-
Definition of the singular series S(h).
-/
open Nat ArithmeticFunction Finset Real

/-- The singular series S(h). Placeholder value 1. -/
def singularSeries (h : ℕ) : ℝ := 1

/-
Definition of the E2 error term.
-/
open Nat ArithmeticFunction Finset Real
open scoped BigOperators

def E2 (X : ℝ) (q : ℕ) (a : ℕ) (h : ℕ) : ℝ :=
  (∑ n ∈ range (⌊X⌋₊ + 1), if n ≡ a [MOD q] then (Λ n * Λ (n + h)) else 0) -
  singularSeries h * X / (totient q : ℝ)^2

/-
Definition of the GEH-2 condition.
-/
noncomputable def GEH2 (X : ℝ) (θ : ℝ) (h : ℕ) (A : ℝ) (C : ℝ) : Prop :=
  (∑ q ∈ range (⌊X^θ⌋₊ + 1),
    ((range q).fold max 0 (fun a => if a.Coprime q then Real.toNNReal (|E2 X q a h|) else 0) : ℝ)) ≤ C * X / (Real.log X)^A

/-
Definition of the Modular Hamiltonian.
-/
noncomputable def ModularHamiltonian (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (q : ℕ) (p r : ℕ) : ℝ :=
  K (ξ p) (ξ r) * if p ≡ r [MOD q] then 1 else 0

/-
Definition of the Accumulated Hamiltonian.
-/
noncomputable def AccumulatedHamiltonian (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (Q : Finset ℕ) (w : ℕ → ℝ) (p r : ℕ) : ℝ :=
  ∑ q ∈ Q, w q * ModularHamiltonian ξ K q p r

/-
Definition of E_comm restricted to residue class.
-/
noncomputable def E_comm_restricted (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (X : ℝ) (q : ℕ) (a : ℕ) : ℝ :=
  ∑ p ∈ range (⌊X⌋₊ + 1),
    if Nat.Prime p ∧ Nat.Prime (p + 2) ∧ p ≡ a [MOD q]
    then (ξ (p + 2) - ξ p)^2 * (K (ξ p) (ξ (p + 2)))^2
    else 0

/-
Definition of T_q, the count of twin primes in a residue class.
-/
noncomputable def T_q (X : ℝ) (q : ℕ) (a : ℕ) : ℕ :=
  ((range (⌊X⌋₊ + 1)).filter (fun p => p ≡ a [MOD q] ∧ Nat.Prime p ∧ Nat.Prime (p + 2))).card

/-
Definition of T(X), the total count of twin primes up to X.
-/
noncomputable def T (X : ℝ) : ℕ :=
  ((range (⌊X⌋₊ + 1)).filter (fun p => Nat.Prime p ∧ Nat.Prime (p + 2))).card

/-
Definition of Variance in class.
-/
open Nat ArithmeticFunction Finset Real
open scoped BigOperators

def Var_q (X : ℝ) (q : ℕ) : ℝ :=
  ∑ a ∈ range q, if a.Coprime q then ((T_q X q a : ℝ) - (T X : ℝ) / (totient q : ℝ))^2 else 0

/-
Definition of E_comm_twin as the weighted sum of restricted E_comm terms.
-/
open Nat ArithmeticFunction Finset Real
open scoped BigOperators

def E_comm_twin (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (X : ℝ) (Q : Finset ℕ) (w : ℕ → ℝ) : ℝ :=
  ∑ q ∈ Q, w q * ∑ a ∈ range q, E_comm_restricted ξ K X q a

/-
Theorem 1: E_comm decomposition by modulus.
-/
theorem Thm1_E_comm_decomposition (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (X : ℝ) (Q : Finset ℕ) (w : ℕ → ℝ) :
  E_comm_twin ξ K X Q w = ∑ q ∈ Q, w q * ∑ a ∈ range q, E_comm_restricted ξ K X q a := by
  rfl

/-
Definitions of AdmissibleModel and Deviation.
-/
opaque AdmissibleModel (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) : Prop

noncomputable def Deviation (X : ℝ) (q : ℕ) (a : ℕ) : ℝ :=
  (T_q X q a : ℝ) - (T X : ℝ) / (totient q : ℝ)

/-
Statement of Theorem 2: E_comm lower bound via variance.
-/
def Thm2_Statement : Prop :=
  ∀ ξ K, AdmissibleModel ξ K →
  ∃ c > 0, ∀ X ≥ 2, ∀ q a,
  E_comm_restricted ξ K X q a ≥ c * (Deviation X q a)^2 * (Real.log X)^2

/-
Statement of Theorem 3: Variance-E2 relation (bounds).
-/
def Thm3_Statement : Prop :=
  ∀ X ≥ 2, ∀ q,
  ∃ C1 C2 : ℝ, C1 > 0 ∧ C2 > 0 ∧
  C1 * (∑ a ∈ range q, |E2 X q a 2|^2) / (Real.log X)^4 ≤ Var_q X q ∧
  Var_q X q ≤ C2 * (∑ a ∈ range q, |E2 X q a 2|^2) / (Real.log X)^4

/-
Statement of Theorem 4: GEH-2 failure implies E_comm growth.
-/
def Thm4_Statement : Prop :=
  ∀ (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (Q : ℝ → Finset ℕ) (w : ℝ → ℕ → ℝ) (A c : ℝ),
  (∃ (X_n : ℕ → ℝ) (q_n : ℕ → ℕ) (a_n : ℕ → ℕ),
    Filter.Tendsto X_n Filter.atTop Filter.atTop ∧
    ∀ n, |E2 (X_n n) (q_n n) (a_n n) 2| ≥ c * (X_n n) / (Real.log (X_n n))^A) →
  ∃ (X_n : ℕ → ℝ), Filter.Tendsto X_n Filter.atTop Filter.atTop ∧
    Filter.Tendsto (fun n => E_comm_twin ξ K (X_n n) (Q (X_n n)) (w (X_n n))) Filter.atTop Filter.atTop

/-
Statement of Theorem 5: E_comm bounded implies GEH-2 (partial).
-/
def Thm5_Statement : Prop :=
  ∀ (ξ : ℕ → ℝ) (K : ℝ → ℝ → ℝ) (Q : ℝ → Finset ℕ) (w : ℝ → ℕ → ℝ),
  (∃ C, ∀ X ≥ 2, |E_comm_twin ξ K X (Q X) (w X)| ≤ C) →
  ∀ q, ∃ C_q, ∀ X ≥ 2, Var_q X q ≤ C_q