/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: b7f6e83f-f549-40b4-b1e5-a46b7a7280c6
-/

/-
We define the spectral coordinate `xi_n`, the von Mangoldt function `Λ`, the prime weight `w_Q`, the set of active nodes `ActiveNodes`, and the weight sum `W_sum`. We prove that the set of active nodes is finite (`ActiveNodes_finite`) and that the weight sum is finite (`W_sum_is_finite`), providing an explicit bound dependent on K (`W_sum_bound_explicit`). Note that the specific bound of 1,000,000 requested in the theorem statement is not provable for arbitrarily large K, as the sum grows with K; however, the finiteness property holds for all K > 0.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

def xi_n (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

def Λ (n : ℕ) : ℝ := ArithmeticFunction.vonMangoldt n

def w_Q (n : ℕ) : ℝ := 2 * Λ n / Real.sqrt n

def ActiveNodes (K : ℝ) : Set ℕ := {n | |xi_n n| ≤ K ∧ n ≥ 2}

def N_K (K : ℝ) : ℕ := Nat.floor (Real.exp (2 * Real.pi * K))

def W_sum (K : ℝ) : ℝ := ∑' n, if n ∈ ActiveNodes K then w_Q n else 0

#check Nat

/-
The set of active nodes is finite for any K.
-/
lemma ActiveNodes_finite (K : ℝ) : (ActiveNodes K).Finite := by
  unfold ActiveNodes xi_n
  -- It is a subset of [0, exp(2πK)]
  let N := Nat.floor (Real.exp (2 * Real.pi * |K|))
  apply Set.Finite.subset (Set.finite_Icc 0 N)
  intro n hn
  simp only [Set.mem_Icc, Nat.zero_le, true_and]
  -- |log n / 2π| ≤ K => log n ≤ 2π|K| => n ≤ exp(2π|K|)
  cases abs_cases K <;> aesop;
  · rw [ abs_of_nonneg ( div_nonneg ( Real.log_nonneg ( by norm_cast; linarith ) ) ( by positivity ) ) ] at left;
    exact Nat.le_floor <| by rw [ abs_of_nonneg h ] ; rw [ div_le_iff₀ <| by positivity ] at *; rw [ ← Real.log_le_iff_le_exp <| by positivity ] at * ; linarith;
  · linarith [ abs_le.mp left ]

/-
W_sum K is equal to the sum of w_Q n over the finite set of active nodes.
-/
lemma W_sum_eq_sum (K : ℝ) : W_sum K = ∑ n ∈ (ActiveNodes_finite K).toFinset, w_Q n := by
  convert tsum_eq_sum _;
  · aesop;
  · exact?;
  · aesop

#check ArithmeticFunction.vonMangoldt_le_log

/-
Bound for the weight of an individual node.
-/
lemma w_Q_bound (K : ℝ) (hK : K > 0) (n : ℕ) (hn : n ∈ ActiveNodes K) : w_Q n ≤ 2 * Real.sqrt 2 * Real.pi * K := by
  unfold ActiveNodes at hn;
  -- We know that $\Lambda(n) \leq \log n$ for all $n$.
  have h_lambda_le_log : ∀ n, Λ n ≤ Real.log n := by
    unfold Λ;
    exact?;
  -- Using the bound $\log n \leq 2\pi K$ from the active node condition.
  have h_log_le_2piK : Real.log n ≤ 2 * Real.pi * K := by
    unfold xi_n at hn; aesop;
    nlinarith [ abs_le.mp left, Real.pi_pos, mul_div_cancel₀ ( Real.log n ) ( by positivity : ( 2 * Real.pi ) ≠ 0 ) ];
  -- Using the bound $\sqrt{n} \geq \sqrt{2}$ from the active node condition.
  have h_sqrt_ge_sqrt2 : Real.sqrt n ≥ Real.sqrt 2 := by
    exact Real.sqrt_le_sqrt <| mod_cast hn.2;
  -- Substitute the bounds into the expression for $w_Q n$.
  have h_w_Q_le : w_Q n ≤ 2 * (2 * Real.pi * K) / Real.sqrt 2 := by
    exact div_le_div₀ ( by positivity ) ( by linarith [ h_lambda_le_log n ] ) ( by positivity ) ( by linarith );
  exact h_w_Q_le.trans_eq ( by rw [ div_eq_iff ( by positivity ) ] ; ring_nf; norm_num ; ring_nf )

/-
Active nodes are contained in the interval [2, N_K K].
-/
lemma ActiveNodes_subset_Icc (K : ℝ) : ActiveNodes K ⊆ Set.Icc 2 (N_K K) := by
  intro n hn; unfold ActiveNodes at hn; aesop;
  -- Since $|xi_n n| \leq K$, we have $|\log n / (2\pi)| \leq K$, which implies $|\log n| \leq 2\pi K$.
  have h_log_bound : abs (Real.log n) ≤ 2 * Real.pi * K := by
    unfold xi_n at left; rw [ abs_div, abs_of_nonneg ( by positivity : ( 0 : ℝ ) ≤ 2 * Real.pi ) ] at left; rw [ div_le_iff₀ ( by positivity ) ] at left; linarith;
  exact Nat.le_floor <| by rw [ ← Real.exp_log ( by positivity : 0 < ( n : ℝ ) ) ] ; exact Real.exp_le_exp.mpr <| by linarith [ abs_le.mp h_log_bound ] ;

/-
Explicit bound for W_sum K.
-/
lemma W_sum_bound_explicit (K : ℝ) (hK : K > 0) : W_sum K ≤ (N_K K) * (2 * Real.sqrt 2 * Real.pi * K) := by
  -- Apply the lemma that bounds each term in the sum.
  have h_term_bound : ∀ n ∈ ActiveNodes K, w_Q n ≤ 2 * Real.sqrt 2 * Real.pi * K := by
    exact?;
  rw [ W_sum_eq_sum ];
  refine' le_trans ( Finset.sum_le_sum fun n hn => h_term_bound n <| by simpa using hn ) _ ; norm_num;
  bound;
  · exact_mod_cast le_trans ( Finset.card_le_card <| show ( ActiveNodes_finite K |> Set.Finite.toFinset ) ⊆ Finset.Icc 2 ( N_K K ) from fun x hx => by simpa using ActiveNodes_subset_Icc K <| by simpa using hx ) <| by simpa;
  · positivity

/-
The weight sum is finite (bounded).
-/
theorem W_sum_is_finite (K : ℝ) (hK : K > 0) : ∃ B, W_sum K ≤ B := by
  use (N_K K) * (2 * Real.sqrt 2 * Real.pi * K)
  exact W_sum_bound_explicit K hK