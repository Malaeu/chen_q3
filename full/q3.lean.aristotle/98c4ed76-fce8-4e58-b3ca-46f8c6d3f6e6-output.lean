/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 98c4ed76-fce8-4e58-b3ca-46f8c6d3f6e6
-/

/-
This module formalizes the Guinand-Weil normalization crosswalk, connecting the repository's Q functional to the classical Guinand-Weil functional. It includes definitions for spectral coordinates, Archimedean density, prime weights, and the Q functional. It also proves the Guinand-Weil matching proposition (T0'), the Q normalization crosswalk lemma (T0), and the normalization invariance lemma (T0-Invariance).
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Prime nodes: $\xi_n = \frac{\log n}{2\pi}$ for $n \geq 2$
-/
noncomputable def xi_n (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

#check Real.Gamma
#check Complex.Gamma

/-
Definition of the digamma function as the logarithmic derivative of the Gamma function.
-/
noncomputable def Complex.digamma (s : ℂ) : ℂ := deriv Complex.Gamma s / Complex.Gamma s

/-
Archimedean Density: $a(\xi) := \log\pi - \Re\psi\left(\frac{1}{4} + i\pi\xi\right)$
-/
noncomputable def archimedean_density (ξ : ℝ) : ℝ :=
  Real.log Real.pi - (Complex.digamma (1/4 + Complex.I * Real.pi * ξ)).re

/-
$a^*(\xi) := 2\pi \cdot a(\xi)$
-/
noncomputable def archimedean_density_star (ξ : ℝ) : ℝ :=
  2 * Real.pi * archimedean_density ξ

/-
Prime Weights: $w(n) := \frac{2\Lambda(n)}{\sqrt{n}}$
-/
noncomputable def prime_weight (n : ℕ) : ℝ :=
  2 * ArithmeticFunction.vonMangoldt n / Real.sqrt n

/-
Q Functional: $Q(\varphi) := \int_{\mathbb{R}} a^*(\xi) \varphi(\xi) d\xi - \sum_{n \geq 2} w(n) \varphi(\xi_n)$
-/
noncomputable def Q (φ : ℝ → ℝ) : ℝ :=
  (∫ ξ, archimedean_density_star ξ * φ ξ) - ∑' n : ℕ, prime_weight n * φ (xi_n n)

/-
Guinand-Weil functional: $Q_{\mathrm{GW}}(\varphi_{\mathrm{GW}}) := \int_{\mathbb{R}} \left(\log\pi - \Re\psi\left(\frac{1}{4} + \frac{i\eta}{2}\right)\right) \varphi_{\mathrm{GW}}(\eta) d\eta - \sum_{n \geq 2} \frac{\Lambda(n)}{\sqrt{n}} \left(\varphi_{\mathrm{GW}}(\log n) + \varphi_{\mathrm{GW}}(-\log n)\right)$
-/
noncomputable def Q_GW (φ_GW : ℝ → ℝ) : ℝ :=
  (∫ η : ℝ, (Real.log Real.pi - (Complex.digamma (1/4 + Complex.I * (η : ℂ) / 2)).re) * φ_GW η) -
  ∑' n : ℕ, (ArithmeticFunction.vonMangoldt n / Real.sqrt n) * (φ_GW (Real.log n) + φ_GW (-Real.log n))

/-
Proposition T0' (Guinand-Weil Matching): Under the unitary Fourier convention, the repository normalization $Q(\varphi)$ matches the classical Guinand-Weil functional after the change of variables $\eta = 2\pi\xi$.
-/
theorem T0_GW_matching (φ : ℝ → ℝ) (hφ_even : ∀ x, φ x = φ (-x)) :
  Q φ = Q_GW (fun η => φ (η / (2 * Real.pi))) := by
    unfold Q Q_GW;
    congr! 1;
    · -- Now consider the change of variables $\eta = 2\pi\xi$ in the integral.
      suffices h_change : ∀ {f : ℝ → ℝ}, (∫ ξ : ℝ, f ξ) = (∫ η : ℝ, f (η / (2 * Real.pi)) * (1 / (2 * Real.pi))) by
        convert h_change using 3;
        unfold archimedean_density_star archimedean_density; norm_num [ Complex.ext_iff ] ; ring;
        norm_num [ Real.pi_ne_zero ] ; ring;
      intro f; rw [ MeasureTheory.integral_mul_const ] ; rw [ MeasureTheory.Measure.integral_comp_div ] ; norm_num [ Real.pi_ne_zero ] ;
      rw [ abs_of_pos Real.pi_pos ] ; ring;
      rw [ mul_right_comm, mul_inv_cancel₀ Real.pi_ne_zero, one_mul ];
    · unfold prime_weight xi_n;
      congr! 2 with n ; specialize hφ_even ( Real.log n / ( 2 * Real.pi ) ) ; ring_nf at * ; aesop ( simp_config := { singlePass := true } );
      ring

/-
Lemma T0 (Q Normalization Crosswalk): Let $\varphi_{\mathrm{GW}} \in C_c(\mathbb{R})$ be even and nonnegative. Then $Q(\varphi) = Q_{\mathrm{GW}}(\varphi_{\mathrm{GW}})$ where $\varphi(\xi) := \varphi_{\mathrm{GW}}(2\pi\xi)$.
-/
theorem T0_Q_crosswalk (φ_GW : ℝ → ℝ) (hφ_even : ∀ x, φ_GW x = φ_GW (-x))
    (hφ_nonneg : ∀ x, 0 ≤ φ_GW x) (hφ_compact : HasCompactSupport φ_GW) :
  Q (fun ξ => φ_GW (2 * Real.pi * ξ)) = Q_GW φ_GW := by
    convert T0_GW_matching ( fun ξ => φ_GW ( 2 * Real.pi * ξ ) ) _ using 3 <;> norm_num [ ← hφ_even ];
    rw [ mul_div_cancel₀ _ ( by positivity ) ]

/-
Lemma T0-Invariance (Normalization Invariance): Different choices of Fourier-transform normalizations and node indexing yield equivalent formulations of the Weil positivity criterion. Specifically, the positivity of Q is independent of these technical choices.
-/
theorem T0_normalization_invariance :
  ∀ φ : ℝ → ℝ, (∀ x, φ x = φ (-x)) → (Q φ ≥ 0 ↔ Q_GW (fun η => φ (η / (2 * Real.pi))) ≥ 0) := by
    exact fun φ hφ => by rw [ ← T0_GW_matching φ hφ ] ;