<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aristotle Monitor - Q3 Formalization</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            color: #58a6ff;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .subtitle {
            color: #8b949e;
            margin-bottom: 20px;
        }
        .api-key-form {
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }
        input[type="text"] {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
            width: 400px;
            font-family: monospace;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }
        button:hover { background: #2ea043; }
        button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        button.secondary:hover { background: #30363d; }
        .projects {
            display: grid;
            gap: 15px;
        }
        .project {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .project-name {
            font-weight: bold;
            color: #58a6ff;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.COMPLETE { background: #238636; color: white; }
        .status.IN_PROGRESS { background: #1f6feb; color: white; }
        .status.QUEUED { background: #6e7681; color: white; }
        .status.FAILED { background: #da3633; color: white; }
        .status.NOT_STARTED { background: #30363d; color: #8b949e; }
        .progress-bar {
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043);
            transition: width 0.5s ease;
        }
        .project-meta {
            font-size: 12px;
            color: #8b949e;
        }
        .project-id {
            font-family: monospace;
            font-size: 11px;
            color: #6e7681;
        }
        .refresh-info {
            text-align: center;
            color: #6e7681;
            margin-top: 20px;
            font-size: 12px;
        }
        .error {
            background: #da363322;
            border: 1px solid #da3633;
            color: #f85149;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .download-btn {
            background: #1f6feb;
            font-size: 12px;
            padding: 4px 8px;
        }
        .download-btn:hover { background: #388bfd; }
        #lastUpdate {
            color: #58a6ff;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary-item {
            background: #161b22;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
            text-align: center;
        }
        .summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #58a6ff;
        }
        .summary-label {
            font-size: 12px;
            color: #8b949e;
        }
    </style>
</head>
<body>
    <h1>üî¨ Aristotle Monitor</h1>
    <p class="subtitle">Q3 Formalization - Path A</p>

    <div class="api-key-form">
        <input type="text" id="apiKey" placeholder="Enter your ARISTOTLE_API_KEY...">
        <button onclick="saveApiKey()">Save Key</button>
        <button class="secondary" onclick="refresh()">üîÑ Refresh</button>
        <button class="secondary" onclick="toggleAutoRefresh()">‚è±Ô∏è Auto (30s)</button>
    </div>

    <div id="error"></div>

    <div class="summary" id="summary">
        <div class="summary-item">
            <div class="summary-value" id="totalProjects">-</div>
            <div class="summary-label">Total</div>
        </div>
        <div class="summary-item">
            <div class="summary-value" id="completeCount">-</div>
            <div class="summary-label">Complete</div>
        </div>
        <div class="summary-item">
            <div class="summary-value" id="inProgressCount">-</div>
            <div class="summary-label">In Progress</div>
        </div>
        <div class="summary-item">
            <div class="summary-value" id="queuedCount">-</div>
            <div class="summary-label">Queued</div>
        </div>
    </div>

    <div class="projects" id="projects">
        <p style="color: #8b949e;">Enter API key and click Refresh...</p>
    </div>

    <div class="refresh-info">
        Last update: <span id="lastUpdate">never</span> |
        Auto-refresh: <span id="autoStatus">OFF</span>
    </div>

    <script>
        const BASE_URL = 'https://aristotle.harmonic.fun/api/v1';
        let autoRefreshInterval = null;

        // Q3 Project IDs to monitor
        const Q3_PROJECTS = [
            { name: '01_T0_normalization', id: '98c4ed76-fce8-4e58-b3ca-46f8c6d3f6e6' },
            { name: '02_A1prime_local_density', id: '098c51d6-908e-4a65-a15a-65e9060e6358' },
            { name: '03_A2_lipschitz', id: '8337e17d-d2ca-4231-adb9-929e45e3fc8f' },
            { name: '04_A3_toeplitz_main', id: 'f62e1767-5adb-4d52-99cc-58831c8201c6' },
            { name: '05_RKHS_prime_cap', id: '34be4dc5-7272-42a8-9be8-59f4be0d90f8' },
            { name: '06_T5_transfer', id: 'f3991944-86d5-4667-93d4-d7d19dc15dab' },
            { name: '07_Main_closure', id: '6e8bdd2f-2503-471e-a132-b81a36a31b1f' },
        ];

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('aristotle_api_key', key);
            refresh();
        }

        function getApiKey() {
            const input = document.getElementById('apiKey');
            const stored = localStorage.getItem('aristotle_api_key');
            if (stored && !input.value) {
                input.value = stored;
            }
            return input.value || stored;
        }

        async function fetchProject(projectId) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error('No API key');

            const response = await fetch(`${BASE_URL}/project/${projectId}`, {
                headers: { 'X-API-Key': apiKey }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            return await response.json();
        }

        async function refresh() {
            const errorDiv = document.getElementById('error');
            const projectsDiv = document.getElementById('projects');

            errorDiv.innerHTML = '';

            const apiKey = getApiKey();
            if (!apiKey) {
                errorDiv.innerHTML = '<div class="error">Please enter your API key</div>';
                return;
            }

            projectsDiv.innerHTML = '<p style="color: #8b949e;">Loading...</p>';

            let complete = 0, inProgress = 0, queued = 0;
            const projectHtml = [];

            for (const proj of Q3_PROJECTS) {
                try {
                    const data = await fetchProject(proj.id);
                    const status = data.status || 'UNKNOWN';
                    const percent = data.percent_complete || 0;

                    if (status === 'COMPLETE') complete++;
                    else if (status === 'IN_PROGRESS') inProgress++;
                    else if (status === 'QUEUED') queued++;

                    projectHtml.push(`
                        <div class="project">
                            <div class="project-header">
                                <span class="project-name">${proj.name}</span>
                                <span class="status ${status}">${status}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percent, 100)}%"></div>
                            </div>
                            <div class="project-meta">
                                Progress: ${percent}% |
                                Updated: ${data.last_updated_at ? new Date(data.last_updated_at).toLocaleTimeString() : 'N/A'}
                                ${status === 'COMPLETE' ? `<button class="download-btn" onclick="downloadSolution('${proj.id}', '${proj.name}')">‚¨áÔ∏è Download</button>` : ''}
                            </div>
                            <div class="project-id">${proj.id}</div>
                        </div>
                    `);
                } catch (err) {
                    projectHtml.push(`
                        <div class="project">
                            <div class="project-header">
                                <span class="project-name">${proj.name}</span>
                                <span class="status FAILED">ERROR</span>
                            </div>
                            <div class="project-meta">Error: ${err.message}</div>
                            <div class="project-id">${proj.id}</div>
                        </div>
                    `);
                }
            }

            projectsDiv.innerHTML = projectHtml.join('');
            document.getElementById('totalProjects').textContent = Q3_PROJECTS.length;
            document.getElementById('completeCount').textContent = complete;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('queuedCount').textContent = queued;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function downloadSolution(projectId, name) {
            const apiKey = getApiKey();
            if (!apiKey) return alert('No API key');

            try {
                const response = await fetch(`${BASE_URL}/project/${projectId}/result`, {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_aristotle.lean`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert('Download failed: ' + err.message);
            }
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('autoStatus').textContent = 'OFF';
            } else {
                autoRefreshInterval = setInterval(refresh, 30000);
                document.getElementById('autoStatus').textContent = 'ON (30s)';
                refresh();
            }
        }

        // Load saved API key on page load
        window.onload = () => {
            const stored = localStorage.getItem('aristotle_api_key');
            if (stored) {
                document.getElementById('apiKey').value = stored;
            }
        };
    </script>
</body>
</html>
