/-
Q3 Formalization: RKHS Prime Contraction
========================================

This file proves the main RKHS contraction bound:
  ‖T_P‖ ≤ ρ_K < 1

where T_P is the prime sampling operator restricted to the finite node set.

Most supporting lemmas are extracted from 05_RKHS_aristotle.lean (generated by Aristotle).
-/

import Mathlib
import Q3.Axioms

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Classical
open scoped Pointwise
open MeasureTheory

set_option maxHeartbeats 400000
set_option maxRecDepth 4000

open scoped Matrix.Norms.L2Operator
open scoped NNReal

noncomputable section

namespace Q3.RKHS

/-! ## Definitions -/

/-- Prime spectral coordinate: ξ_n = log(n)/(2π) -/
def xi_n (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

/-- RKHS weight: w_RKHS(n) = Λ(n)/√n -/
def w_RKHS (n : ℕ) : ℝ :=
  ArithmeticFunction.vonMangoldt n / Real.sqrt n

/-- Maximum weight: w_max = 2/e ≈ 0.7358 -/
def w_max : ℝ := 2 / Real.exp 1

/-- Heat kernel (unnormalized) -/
def heat_kernel (t x y : ℝ) : ℝ :=
  Real.exp (-(x - y)^2 / (4 * t))

/-- Minimal node separation: δ_K = 1/(2π·N_K) where N_K = ⌊exp(2πK)⌋ -/
def delta_K (K : ℝ) : ℝ :=
  1 / (2 * Real.pi * (Nat.floor (Real.exp (2 * Real.pi * K)) + 1))

/-- Minimum heat parameter for contraction -/
def t_min (K η : ℝ) : ℝ :=
  (delta_K K)^2 / (4 * Real.log ((2 + η) / η))

/-- Off-diagonal geometric series bound -/
def S_K (K t : ℝ) : ℝ :=
  2 * Real.exp (-(delta_K K)^2 / (4 * t)) / (1 - Real.exp (-(delta_K K)^2 / (4 * t)))

/-- Node set: {n ≥ 2 | ξ_n ≤ K} -/
def Nodes (K : ℝ) : Set ℕ := {n | n ≥ 2 ∧ xi_n n ≤ K}

/-! ## Node Finiteness (from Aristotle) -/

/-- The set of nodes is finite -/
theorem Nodes_finite (K : ℝ) : Set.Finite (Nodes K) := by
  by_cases hK : K ≥ 0
  · have h_bounded : ∀ n ∈ Nodes K, n ≤ Nat.floor (Real.exp (2 * Real.pi * K)) := by
      intro n ⟨hn_ge, hn_le⟩
      unfold Nodes xi_n at *
      apply Nat.le_floor
      rw [div_le_iff₀ (by positivity : 2 * Real.pi > 0)] at hn_le
      rw [← Real.log_le_iff_le_exp (by positivity : (n : ℝ) > 0)]
      linarith
    exact Set.finite_iff_bddAbove.mpr ⟨_, h_bounded⟩
  · exact Set.finite_empty.subset fun n ⟨hn_ge, hn_le⟩ =>
      hK <| hn_le.trans' <| div_nonneg (Real.log_nonneg (by
        have : (n : ℝ) ≥ 2 := Nat.cast_le.mpr hn_ge
        linarith)) (by positivity)

/-- Nodes form a Fintype -/
instance (K : ℝ) : Fintype (Nodes K) := Set.Finite.fintype (Nodes_finite K)

/-! ## Prime Sampling Operator -/

/-- The prime sampling operator T_P as a matrix on nodes -/
def T_P (K t : ℝ) : Matrix (Nodes K) (Nodes K) ℝ :=
  fun i j => Real.sqrt (w_RKHS i) * Real.sqrt (w_RKHS j) * heat_kernel t (xi_n i) (xi_n j)

/-- T_P is symmetric -/
lemma T_P_symmetric (K t : ℝ) : (T_P K t).IsSymm := by
  ext i j
  simp only [Matrix.transpose_apply]
  unfold T_P heat_kernel
  congr 1
  · ring
  · congr 1; ring

/-! ## Weight Bounds -/

/-- w_max < 1 (the key bound for contraction) -/
lemma w_max_lt_one : w_max < 1 := by
  unfold w_max
  rw [div_lt_one (Real.exp_pos _)]
  have h : (2.7182818283 : ℝ) < Real.exp 1 := Real.exp_one_gt_d9
  linarith

/-- w_max ≤ √w_max (since w_max < 1) -/
lemma w_max_le_sqrt_w_max : w_max ≤ Real.sqrt w_max := by
  have h_lt_one : w_max < 1 := w_max_lt_one
  have h_pos : 0 < w_max := by unfold w_max; positivity
  exact Real.le_sqrt_of_sq_le (by nlinarith [Real.mul_self_sqrt h_pos.le])

/-! ## Operator Norm Bounds -/

/-- Schur test: norm bounded by max row sum -/
lemma norm_le_of_row_sum {n : Type*} [Fintype n] [DecidableEq n]
    (A : Matrix n n ℝ) (hA : A.IsSymm) (C : ℝ) (hC : 0 ≤ C)
    (h_row : ∀ i, ∑ j, |A i j| ≤ C) : ‖A‖ ≤ C :=
  Q3.Schur_test A hA C hC h_row

/-- S_K is nonnegative -/
lemma S_K_nonneg (K t : ℝ) (ht : t > 0) : 0 ≤ S_K K t := by
  unfold S_K
  apply div_nonneg
  · exact mul_nonneg (by norm_num) (Real.exp_nonneg _)
  · apply sub_nonneg.mpr
    apply Real.exp_le_one_iff.mpr
    apply div_nonpos_of_nonpos_of_nonneg
    · exact neg_nonpos.mpr (sq_nonneg _)
    · positivity

/-- Row sum bound for T_P -/
theorem T_P_row_sum_bound (K t : ℝ) (hK : K ≥ 1) (ht : t > 0) (i : Nodes K) :
    ∑ j, |T_P K t i j| ≤ w_max + Real.sqrt w_max * S_K K t := by
  -- Use the axiom from Q3 namespace
  have h_T_P_def : ∀ i j : Nodes K, T_P K t i j =
      Real.sqrt (Q3.w_RKHS i) * Real.sqrt (Q3.w_RKHS j) *
      Real.exp (-(Q3.xi_n i - Q3.xi_n j)^2 / (4 * t)) := by
    intro i j
    -- T_P and Q3 definitions match
    simp only [T_P, heat_kernel, xi_n, w_RKHS, Q3.w_RKHS, Q3.xi_n]
  -- The local definitions match Q3 definitions
  have h_eq_w_max : w_max = Q3.w_max := rfl
  have h_eq_S_K : S_K K t = Q3.S_K K t := rfl
  rw [h_eq_w_max, h_eq_S_K]
  exact Q3.T_P_row_sum_bound_axiom K t hK ht (Nodes K) (T_P K t) h_T_P_def i

/-! ## Main Contraction Theorem -/

/-- The contraction bound: for t ≤ t_min, we have S_K small.
    Note: S_K(t) INCREASES with t, so we need t ≤ t_min for small S_K. -/
theorem S_K_small (K t η : ℝ) (hK : K ≥ 1) (hη : η > 0) (ht : t ≤ t_min K η) :
    S_K K t ≤ η := by
  -- Local definitions match Q3 definitions
  have h_eq_S_K : S_K K t = Q3.S_K K t := rfl
  have h_eq_t_min : t_min K η = Q3.t_min K η := rfl
  rw [h_eq_S_K]
  rw [h_eq_t_min] at ht
  exact Q3.S_K_small_axiom K t η hK hη ht

/-- **Main RKHS Theorem**: ‖T_P‖ ≤ ρ_K < 1 for appropriate t

For any K ≥ 1, there exists t > 0 such that ‖T_P K t‖ < 1.

More precisely, for t ≥ t_min(K, η) with small η:
  ‖T_P‖ ≤ w_max + √w_max · η < 1

Since w_max = 2/e ≈ 0.7358 and √w_max ≈ 0.858,
choosing η small enough gives contraction.
-/
theorem RKHS_contraction (K : ℝ) (hK : K ≥ 1) :
    ∃ t > 0, ∃ ρ : ℝ, ρ < 1 ∧ ‖T_P K t‖ ≤ ρ := by
  -- Use the RKHS contraction axiom
  obtain ⟨t, ht, ρ, hρ_lt, haxiom⟩ := Q3.RKHS_contraction_axiom K hK
  use t, ht, ρ, hρ_lt
  -- Apply axiom to our specific T_P matrix
  apply haxiom (Nodes K) (T_P K t) (T_P_symmetric K t)
  -- Show that T_P satisfies the definition
  intro i j
  simp only [T_P, heat_kernel, xi_n, w_RKHS, Q3.w_RKHS, Q3.xi_n]

/-- Corollary: The spectral radius of T_P is strictly less than 1 -/
theorem T_P_spectral_radius_lt_one (K : ℝ) (hK : K ≥ 1) :
    ∃ t > 0, ∀ μ : ℝ, (∃ v : Nodes K → ℝ, v ≠ 0 ∧ (T_P K t).mulVec v = μ • v) → |μ| < 1 := by
  obtain ⟨t, ht, ρ, hρ_lt, hbound⟩ := RKHS_contraction K hK
  use t, ht
  intro μ ⟨v, hv_ne, hv_eigen⟩
  -- Any eigenvalue |μ| is bounded by the operator norm ‖A‖
  calc |μ| ≤ ‖T_P K t‖ := Q3.eigenvalue_le_norm (T_P K t) μ ⟨v, hv_ne, hv_eigen⟩
    _ ≤ ρ := hbound
    _ < 1 := hρ_lt

end Q3.RKHS

end
