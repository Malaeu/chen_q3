/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 52696cee-ad2c-4feb-a69f-dbb05bfc7433
-/

/-
This file defines spectral nodes and proves the Node Spacing Lemma, which states that adjacent spectral nodes are separated by at least δ_K.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

def xi_n (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

def Nodes (K : ℝ) : Set ℕ := {n | |xi_n n| ≤ K ∧ n ≥ 2}

def N_K (K : ℝ) : ℕ := Nat.floor (Real.exp (2 * Real.pi * K))

def delta_K (K : ℝ) : ℝ := 1 / (2 * Real.pi * (N_K K + 1))

#check Nat

lemma log_diff_eq_log_div (n₁ n₂ : ℕ) (h₁ : n₁ > 0) (h₂ : n₂ > 0) :
  Real.log n₂ / (2 * Real.pi) - Real.log n₁ / (2 * Real.pi) = Real.log (n₂ / n₁) / (2 * Real.pi) := by
    -- Using the logarithm property $\log(a) - \log(b) = \log\left(\frac{a}{b}\right)$, we can rewrite the difference.
    rw [Real.log_div (by positivity) (by positivity)]
    ring

lemma log_one_plus_inv_ge_inv_add_one (x : ℝ) (hx : x > 0) :
  Real.log (1 + 1 / x) ≥ 1 / (x + 1) := by
    -- We'll use the fact that $\log(1 + y) \geq \frac{y}{1 + y}$ for $y > 0$.
    have h_log_ineq : ∀ y : ℝ, 0 < y → Real.log (1 + y) ≥ y / (1 + y) := by
      exact fun y hy => by rw [ ge_iff_le ] ; rw [ div_le_iff₀ ( by positivity ) ] ; nlinarith [ Real.log_inv ( 1 + y ), Real.log_le_sub_one_of_pos ( inv_pos.mpr ( by positivity : 0 < ( 1 + y ) ) ), mul_inv_cancel₀ ( by positivity : ( 1 + y ) ≠ 0 ) ] ;
    -- Apply the inequality with $y = \frac{1}{x}$.
    specialize h_log_ineq (1 / x) (by positivity);
    -- Simplify the right-hand side of the inequality.
    field_simp [hx] at h_log_ineq ⊢;
    -- Apply the inequality h_log_ineq directly.
    exact h_log_ineq

lemma N_K_pos (K : ℝ) (hK : K ≥ 1) : 0 < N_K K := by
  -- Since $K \geq 1$, we have $2\pi K \geq 2\pi$, and thus $e^{2\pi K} \geq e^{2\pi} > 1$.
  have h_exp_pos : 1 < Real.exp (2 * Real.pi * K) := by
    -- Since $K \geq 1$, we have $2\pi K \geq 2\pi$, and thus $e^{2\pi K} > 1$.
    have h_exp_pos : 0 < 2 * Real.pi * K := by
      -- Since $K \geq 1$ and $\pi > 0$, their product $2\pi K$ is also positive.
      apply mul_pos; exact mul_pos (by norm_num) (Real.pi_pos); exact lt_of_lt_of_le zero_lt_one hK;
    -- Since $2\pi K > 0$, we can apply the fact that the exponential function is strictly increasing to conclude that $e^{2\pi K} > e^0 = 1$.
    apply Real.exp_lt_exp.mpr h_exp_pos |> lt_of_le_of_lt (by norm_num);
  -- Since $e^{2\pi K} > 1$, the floor of $e^{2\pi K}$ is at least 1.
  apply Nat.floor_pos.mpr h_exp_pos.le

lemma n_le_N_K (K : ℝ) (n : ℕ) (hn : n ∈ Nodes K) : n ≤ N_K K := by
  -- Since $n \in Nodes K$, we have $|\ln n / (2\pi)| \leq K$, which implies $\ln n \leq 2\pi K$.
  have h_ln_le : Real.log n ≤ 2 * Real.pi * K := by
    -- By definition of Nodes K, we have |Real.log n / (2 * Real.pi)| ≤ K.
    have h_abs : |Real.log n / (2 * Real.pi)| ≤ K := by
      exact hn.1;
    nlinarith [ abs_le.mp h_abs, Real.pi_pos, mul_div_cancel₀ ( Real.log n ) ( by positivity : ( 2 * Real.pi ) ≠ 0 ) ];
  refine Nat.le_floor ?_;
  rwa [ Real.log_le_iff_le_exp ( Nat.cast_pos.mpr <| Nat.pos_of_ne_zero <| by rintro rfl; exact absurd hn.2 <| by norm_num ) ] at h_ln_le

theorem node_spacing (K : ℝ) (hK : K ≥ 1) :
    ∀ (n₁ n₂ : ℕ), n₁ ∈ Nodes K → n₂ ∈ Nodes K → n₁ < n₂ →
      xi_n n₂ - xi_n n₁ ≥ delta_K K := by
        intro n₁ n₂ hn₁ hn₂ hn₁₂
        set x₁ := n₁
        set x₂ := n₂
        have h_log_div : Real.log (x₂ / x₁) ≥ Real.log (1 + 1 / x₁) := by
          bound;
          · positivity;
          · rw [ le_div_iff₀ ] <;> aesop;
            · nlinarith [ inv_mul_cancel₀ ( show ( n₁ : ℝ ) ≠ 0 by norm_cast; linarith [ hn₁.2 ] ), show ( n₁ : ℝ ) + 1 ≤ n₂ by norm_cast ];
            · linarith [ hn₁.2 ];
        -- By combining the inequalities from h_log_div and h_log_add_inv_ge_inv_add_one, we get the desired result.
        have h_final_order : Real.log (1 + 1 / (n₁ : ℝ)) ≥ 1 / (N_K K + 1 : ℝ) := by
          -- Since $n₁ \leq N_K K$, we have $1 / (n₁ : ℝ) \geq 1 / (N_K K : ℝ)$.
          have h_inv_le_inv_NK : 1 / (n₁ : ℝ) ≥ 1 / (N_K K : ℝ) := by
            exact one_div_le_one_div_of_le ( Nat.cast_pos.mpr <| Nat.pos_of_ne_zero <| by rintro rfl; exact absurd hn₁.2 <| by norm_num ) <| Nat.cast_le.mpr <| n_le_N_K K n₁ hn₁;
          refine' le_trans _ ( Real.log_le_log ( by positivity ) ( add_le_add_left h_inv_le_inv_NK _ ) );
          convert log_one_plus_inv_ge_inv_add_one ( N_K K : ℝ ) _ using 1 ; norm_num;
          exact N_K_pos K hK;
        unfold xi_n delta_K; aesop;
        rw [ Real.log_div ] at h_log_div <;> ring_nf at * <;> aesop;
        · nlinarith [ inv_pos.mpr Real.pi_pos ];
        · exact not_le_of_gt ( by positivity ) h_final_order