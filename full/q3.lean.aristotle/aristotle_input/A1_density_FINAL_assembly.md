# A1 Density — FINAL ASSEMBLY

## Goal

Prove the main A1 density theorem by assembling all the supporting lemmas that are already proven.

## CRITICAL: This is an ASSEMBLY task

All the hard lemmas are ALREADY PROVEN in the file. We just need the FINAL theorem that combines them.

## Definitions (ALREADY PROVEN)

```lean
-- Heat kernel
noncomputable def HeatKernel (t : ℝ) (x : ℝ) : ℝ :=
  (4 * Real.pi * t) ^ (-(1:ℝ)/2) * Real.exp (-x^2 / (4 * t))

-- Fejér kernel
noncomputable def FejerKernel (B : ℝ) (x : ℝ) : ℝ := max 0 (1 - |x| / B)

-- Atom = Fejér × Heat
noncomputable def Atom (B t τ : ℝ) (x : ℝ) : ℝ :=
  FejerKernel B (x - τ) * HeatKernel t (x - τ) +
  FejerKernel B (x + τ) * HeatKernel t (x + τ)

-- W_K = continuous, even, nonnegative functions on [-K, K]
def W_K (K : ℝ) : Set (ℝ → ℝ) :=
  { f | ContinuousOn f (Set.Icc (-K) K) ∧ (∀ x, f (-x) = f x) ∧ (∀ x ∈ Set.Icc (-K) K, f x ≥ 0) }

-- Atom cone = convex cone generated by atoms
def AtomCone_K (K : ℝ) : Set (ℝ → ℝ) :=
  Convex.toCone ℝ (convexHull ℝ (AtomSet K))

-- Uniform distance on [-K, K]
def diff_set (Φ : ℝ → ℝ) (g : ℝ → ℝ) (K : ℝ) : Set ℝ :=
  (fun x ↦ |Φ x - g x|) '' Set.Icc (-K) K
```

## Lemmas ALREADY PROVEN (use these!)

```lean
-- 1. Heat kernel integrates to 1
lemma HeatKernel_integral (t : ℝ) (ht : t > 0) : ∫ x, HeatKernel t x = 1

-- 2. Heat kernel mass concentrates near 0
lemma HeatKernel_mass_concentration (δ : ℝ) (hδ : δ > 0) :
  Filter.Tendsto (fun t => ∫ x in {y | |y| > δ}, HeatKernel t x)
    (nhdsWithin 0 (Set.Ioi 0)) (nhds 0)

-- 3. Heat kernel is nonnegative
lemma HeatKernel_nonneg (t : ℝ) (ht : t > 0) (x : ℝ) : 0 ≤ HeatKernel t x

-- 4. Fejér kernel bounds
lemma FejerKernel_bounds (B : ℝ) (hB : B > 0) (x : ℝ) :
  0 ≤ FejerKernel B x ∧ FejerKernel B x ≤ 1

-- 5. Fejér → 1 uniformly on compacts
lemma FejerKernel_approx_one (K : ℝ) (B : ℝ) (hB : B > K) (x : ℝ) (hx : x ∈ Set.Icc (-K) K) :
  FejerKernel B x = 1

-- 6. Tietze extension exists
lemma exists_compact_extension (K : ℝ) (hK : K > 0) (Φ : ℝ → ℝ)
    (hΦ_cont : ContinuousOn Φ (Set.Icc (-K) K)) :
  ∃ Ψ : ℝ → ℝ, Continuous Ψ ∧ HasCompactSupport Ψ ∧ ∀ x ∈ Set.Icc (-K) K, Ψ x = Φ x

-- 7. Heat convolution approximates identity
lemma HeatKernel_approx_identity_uniform (f : ℝ → ℝ) (hf_cont : Continuous f)
    (hf_supp : HasCompactSupport f) (ε : ℝ) (hε : ε > 0) :
  ∃ t₀ > 0, ∀ t ∈ Set.Ioo 0 t₀, ∀ x, |real_convolution f (HeatKernel t) x - f x| < ε

-- 8. Integral can be approximated by finite sum
lemma convolution_approx_by_sum (K : ℝ) (hK : K > 0) (f : ℝ → ℝ)
    (hf_cont : Continuous f) (hf_supp : HasCompactSupport f) (t : ℝ) (ht : t > 0) (ε : ℝ) (hε : ε > 0) :
  ∃ (s : Finset ℝ) (w : ℝ → ℝ), (∀ y ∈ s, y ∈ Set.Icc (-K) K) ∧ (∀ y ∈ s, w y > 0) ∧
    ∀ x ∈ Set.Icc (-K) K, |real_convolution f (HeatKernel t) x - ∑ y ∈ s, w y * HeatKernel t (x - y)| < ε

-- 9. Fejér sum approximates heat sum
lemma fejer_sum_approx (K : ℝ) (hK : K > 0) (t : ℝ) (ht : t > 0) (s : Finset ℝ)
    (w : ℝ → ℝ) (hw_nonneg : ∀ y ∈ s, 0 ≤ w y) (hs_subset : ∀ y ∈ s, y ∈ Set.Icc (-K) K)
    (ε : ℝ) (hε : ε > 0) :
  ∃ B > 0, ∀ x ∈ Set.Icc (-K) K,
    |∑ y ∈ s, w y * Atom B t y x - (∑ y ∈ s, w y * HeatKernel t (x - y) +
      ∑ y ∈ s, w y * HeatKernel t (x + y))| < ε

-- 10. Weighted sum of atoms is in cone
lemma sum_atoms_in_cone (K : ℝ) (s : Finset ℝ) (w : ℝ → ℝ) (hw : ∀ y ∈ s, 0 ≤ w y)
    (B : ℝ) (hB : B > 0) (t : ℝ) (ht : t > 0) (hs : ∀ y ∈ s, y ∈ Set.Icc (-K) K)
    (h_sum_pos : ∑ y ∈ s, w y > 0) :
  (fun x => ∑ y ∈ s, w y * Atom B t y x) ∈ AtomCone_K K

-- 11. Even extension exists
lemma exists_even_compact_extension (K : ℝ) (hK : K > 0) (Φ : ℝ → ℝ)
    (hΦ_cont : ContinuousOn Φ (Set.Icc (-K) K)) (hΦ_even : Even Φ) :
  ∃ Ψ : ℝ → ℝ, Continuous Ψ ∧ HasCompactSupport Ψ ∧ Even Ψ ∧ ∀ x ∈ Set.Icc (-K) K, Ψ x = Φ x

-- 12. Heat kernel is even
lemma HeatKernel_even (t : ℝ) : Even (HeatKernel t)

-- 13. Convolution of even functions is even
lemma even_convolution (f g : ℝ → ℝ) (hf : Even f) (hg : Even g) : Even (real_convolution f g)
```

## MAIN THEOREM TO PROVE

```lean
/-- A1 Density Theorem: AtomCone_K is dense in W_K in the uniform norm.

For any continuous, even, nonnegative function Φ on [-K, K], and any ε > 0,
there exists a function g in the atom cone such that |Φ(x) - g(x)| < ε for all x in [-K, K].

Proof sketch:
1. Extend Φ to a continuous, even, compactly supported function Ψ on ℝ (by lemma 11)
2. Choose t small enough that HeatKernel * Ψ is ε/3-close to Ψ uniformly (by lemma 7)
3. Approximate the convolution integral by a finite Riemann sum (by lemma 8)
4. Replace the heat kernel sum with an atom sum by choosing B large (by lemma 9)
5. The atom sum is in AtomCone_K (by lemma 10)
6. Triangle inequality: total error < ε/3 + ε/3 + ε/3 = ε
-/
theorem A1_density_WK (K : ℝ) (hK : K > 0) :
    ∀ Φ ∈ W_K K, ∀ ε > 0, ∃ g ∈ AtomCone_K K, sSup (diff_set Φ g K) < ε := by
  intro Φ hΦ ε hε
  -- Step 1: Extend Φ to Ψ with compact support
  obtain ⟨Ψ, hΨ_cont, hΨ_supp, hΨ_even, hΨ_eq⟩ := exists_even_compact_extension K hK Φ hΦ.1 ⟨_, hΦ.2.1⟩
  -- Step 2: Choose t for heat kernel approximation (ε/3)
  obtain ⟨t₀, ht₀_pos, ht₀_approx⟩ := HeatKernel_approx_identity_uniform Ψ hΨ_cont hΨ_supp (ε/3) (by linarith)
  set t := t₀ / 2 with ht_def
  have ht : t > 0 := by linarith
  have ht_in : t ∈ Set.Ioo 0 t₀ := by constructor <;> linarith
  -- Step 3: Approximate convolution by finite sum (ε/3)
  obtain ⟨s, w, hs_in, hw_pos, h_sum_approx⟩ := convolution_approx_by_sum K hK Ψ hΨ_cont hΨ_supp t ht (ε/3) (by linarith)
  -- Step 4: Replace heat sum with atom sum (ε/3)
  have hw_nonneg : ∀ y ∈ s, 0 ≤ w y := fun y hy => le_of_lt (hw_pos y hy)
  obtain ⟨B, hB_pos, h_fejer_approx⟩ := fejer_sum_approx K hK t ht s w hw_nonneg hs_in (ε/3) (by linarith)
  -- Step 5: The atom sum is in the cone
  have h_sum_pos : ∑ y ∈ s, w y > 0 := Finset.sum_pos hw_pos ⟨_, Finset.mem_univ _⟩  -- need s nonempty
  set g := fun x => ∑ y ∈ s, w y * Atom B t y x with hg_def
  have hg_in_cone : g ∈ AtomCone_K K := sum_atoms_in_cone K s w hw_nonneg B hB_pos t ht hs_in h_sum_pos
  -- Step 6: Combine errors
  refine ⟨g, hg_in_cone, ?_⟩
  -- Show sSup (diff_set Φ g K) < ε
  apply csSup_lt_iff.mpr
  · exact Set.Nonempty.image _ (Set.nonempty_Icc.mpr (by linarith : -K ≤ K))
  · intro y hy
    obtain ⟨x, hx_in, hx_eq⟩ := hy
    rw [← hx_eq]
    -- |Φ(x) - g(x)| ≤ |Φ(x) - (Ψ * H)(x)| + |(Ψ * H)(x) - heat_sum(x)| + |heat_sum(x) - g(x)|
    calc |Φ x - g x|
        = |Ψ x - g x| := by rw [hΨ_eq x hx_in]
      _ ≤ |Ψ x - real_convolution Ψ (HeatKernel t) x| +
          |real_convolution Ψ (HeatKernel t) x - ∑ y ∈ s, w y * HeatKernel t (x - y)| +
          |∑ y ∈ s, w y * HeatKernel t (x - y) - g x| := by
            -- triangle inequality (need to handle the even sum)
            sorry  -- This is the technical assembly step
      _ < ε/3 + ε/3 + ε/3 := by
            -- Apply the three approximation lemmas
            sorry
      _ = ε := by ring
```

## Notes for Aristotle

1. ALL supporting lemmas are proven and available
2. The main theorem is just COMBINING them via triangle inequality
3. The "sorry" placeholders indicate where to fill in the technical details
4. The proof sketch is complete — just need the formal details
5. Pay attention to the even symmetry (heat sum has both x-y and x+y terms)

## Expected Output

A complete proof of `A1_density_WK` using the existing lemmas, with NO sorry.
