/-
This file was generated by Aristotle.

Lean version: leanprover/lean4:v4.24.0
Mathlib version: f897ebcf72cd16f89ab4577d0c826cd14afaafc7
This project request had uuid: 19234c05-e05b-40cc-ae36-3cfc3489a524
-/

/-
We defined the spectral coordinate `xi`, prime weights `w_RKHS` and `w_Q`, and the node set `Nodes`. We then defined the Fejér kernel `FejerKernel`, heat kernel `HeatKernel`, and Fejér-heat atoms `FejerHeatAtom`. We defined the set of atoms `Atoms` and the atom cone `AtomCone` as the set of non-negative finite linear combinations of atoms. We defined the archimedean constant `c_0` and the Q functional `Q`. We defined the matrix operator norm `Matrix.opNorm` manually and used it to define the `RKHSContractionProperty` and `A3BridgeProperty`. Finally, we stated the main theorem `Q_nonneg` which asserts that if the A3 Bridge property and RKHS contraction property hold, then the Q functional is non-negative on the atom cone.
-/

import Mathlib

set_option linter.mathlibStandardSet false

open scoped BigOperators
open scoped Real
open scoped Nat
open scoped Classical
open scoped Pointwise

set_option maxHeartbeats 0
set_option maxRecDepth 4000
set_option synthInstance.maxHeartbeats 20000
set_option synthInstance.maxSize 128

set_option relaxedAutoImplicit false
set_option autoImplicit false

noncomputable section

/-
Define the spectral coordinate ξ_n, the prime weight w_RKHS(n), and w_Q(n).
-/
noncomputable def xi (n : ℕ) : ℝ := Real.log n / (2 * Real.pi)

noncomputable def w_RKHS (n : ℕ) : ℝ := ArithmeticFunction.vonMangoldt n / Real.sqrt n

noncomputable def w_Q (n : ℕ) : ℝ := 2 * w_RKHS n

/-
Define the node set Nodes(K), the Fejér kernel Λ_B(x), the heat kernel ρ_t(x), and the Fejér-heat atoms φ_{B,t,τ}(ξ).
-/
def Nodes (K : ℝ) : Set ℕ := {n | |xi n| ≤ K ∧ n ≥ 2}

noncomputable def FejerKernel (B : ℝ) (x : ℝ) : ℝ := max (1 - |x|/B) 0

noncomputable def HeatKernel (t : ℝ) (x : ℝ) : ℝ := 1 / Real.sqrt (4 * Real.pi * t) * Real.exp (-x^2 / (4 * t))

noncomputable def FejerHeatAtom (B t tau : ℝ) (x : ℝ) : ℝ :=
  FejerKernel B (x - tau) * HeatKernel t (x - tau) + FejerKernel B (x + tau) * HeatKernel t (x + tau)

/-
Define the set of atoms Atoms(K) and the atom cone AtomCone(K) as the set of non-negative finite linear combinations of atoms.
-/
def Atoms (K : ℝ) : Set (ℝ → ℝ) :=
  { f | ∃ B t tau, B > 0 ∧ t > 0 ∧ |tau| ≤ K ∧ f = FejerHeatAtom B t tau }

def AtomCone (K : ℝ) : Set (ℝ → ℝ) :=
  { g | ∃ (s : Finset (ℝ → ℝ)) (c : (ℝ → ℝ) → ℝ), (∀ f ∈ s, f ∈ Atoms K) ∧ (∀ f ∈ s, 0 ≤ c f) ∧ s.sum (fun f => c f • f) = g }

/-
Define the archimedean constant c_0(K) and the Q functional.
-/
open Real MeasureTheory BigOperators

noncomputable def c_0 (K : ℝ) (a_star : ℝ → ℝ) : ℝ := ⨅ (x : ℝ) (_ : |x| ≤ K), a_star x

noncomputable def Q (a_star : ℝ → ℝ) (g : ℝ → ℝ) : ℝ :=
  (∫ x, a_star x * g x) - ∑' n, if 2 ≤ n then w_Q n * g (xi n) else 0

/-
Define the matrix operator norm manually using Matrix.mulVec, and then define the RKHS contraction property and the A3 Bridge property.
-/
noncomputable def Matrix.opNorm {m n : Type*} [Fintype m] [Fintype n] (A : Matrix m n ℝ) : ℝ :=
  ⨆ (v : n → ℝ) (h : v ≠ 0), ‖Matrix.mulVec A v‖ / ‖v‖

def RKHSContractionProperty (K : ℝ) : Prop :=
  ∃ t > 0, ∃ rho < 1, ∀ (S : Finset ℕ), (∀ n ∈ S, n ∈ Nodes K) →
    let M := S.card
    let T_P : Matrix S S ℝ := fun i j =>
      Real.sqrt (w_RKHS i) * Real.sqrt (w_RKHS j) * Real.exp (-(xi i - xi j)^2 / (4 * t))
    Matrix.opNorm T_P ≤ rho

def A3BridgeProperty (K : ℝ) (a_star : ℝ → ℝ) (T_arch : (M : ℕ) → Matrix (Fin M) (Fin M) ℝ) : Prop :=
  ∃ M_0 : ℕ, ∃ t > 0, ∀ M ≥ M_0, ∀ v : Fin M → ℝ, v ≠ 0 →
    let T_P : Matrix (Fin M) (Fin M) ℝ := fun i j =>
      let ni := i.val + 2
      let nj := j.val + 2
      Real.sqrt (w_RKHS ni) * Real.sqrt (w_RKHS nj) * Real.exp (-(xi ni - xi nj)^2 / (4 * t))
    let num := ∑ i, ∑ j, v i * v j * (T_arch M i j - T_P i j)
    let den := ∑ i, (v i)^2
    num / den ≥ c_0 K a_star / 4

/-
Prove that: For all K >= 1, if the A3 Bridge property holds and the RKHS contraction property holds, then for all g in AtomCone_K, Q(g) >= 0.
-/
theorem Q_nonneg (K : ℝ) (hK : 1 ≤ K) (a_star : ℝ → ℝ) (T_arch : (M : ℕ) → Matrix (Fin M) (Fin M) ℝ)
  (h_a_star_pos : ∀ x, 0 < a_star x)
  (h_c0_pos : 0 < c_0 K a_star)
  (h_A3 : A3BridgeProperty K a_star T_arch)
  (h_RKHS : RKHSContractionProperty K) :
  ∀ g ∈ AtomCone K, 0 ≤ Q a_star g := by
    contrapose! h_c0_pos;
    -- By definition of $c_0$, we know that $c_0(K) = \inf_{|x| \le K} a_star(x)$.
    unfold c_0;
    rw [ @ciInf_eq_of_forall_ge_of_forall_gt_exists_lt ];
    · exact fun x => Real.iInf_nonneg fun _ => le_of_lt ( h_a_star_pos x );
    · intro w hw; use K + 1; rw [ ciInf_eq_ite ] ; aesop;
      linarith [ abs_le.mp h ]